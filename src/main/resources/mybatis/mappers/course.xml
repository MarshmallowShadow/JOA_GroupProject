<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="course">

	<!-- 코스 추가 -->
	<insert id="insert" parameterType="coVo">
		<selectKey keyProperty="courseNo" resultType="int" order="BEFORE">
			select SEQ_COURSE_NO.nextval from dual
		</selectKey>
		<![CDATA[
			insert into course
			values (#{courseNo}, #{userNo}, #{title}, #{distance}, #{courseCate}, #{courseTime}, #{difficulty}, sysdate, #{openStatus})
		]]>
	</insert>
	
	
	<!-- 코스 제목 수정 -->
	<update id="updateTitle" parameterType="map">
		<![CDATA[
			update course
			set title = #{modTitle}
			where course_no = #{courseNo}
		]]>
	</update>
	
	
	<!-- 코스 가져오기 -->
	<select id="selectCourse" resultType="coVo" parameterType="int">
		<![CDATA[
			select course_no courseNo
			        ,user_no userNo
			        ,title
			        ,distance
			        ,course_category courseCate
			        ,course_time courseTime
			        ,difficulty
			        ,to_char(reg_date, 'YYYY.MM.DD') regDate
			from course
			where course_no = #{courseNo}
		]]>
	</select>
	
	
	<!-- 기록작성자 번호 가져오기 -->
	<select id="getUserNo" resultType="int" parameterType="int">
		<![CDATA[
			select user_no
			from course
			where course_no = #{courseNo}
		]]>
	</select>
	
	<!-- 지역별 검색 -->
	<select id="locationList" parameterType="map" resultType="map">
	<![CDATA[
		select	c.course_no, title, distance, course_time, course_category, difficulty,
				id,
				p.order_no, x, y
		from course c, users u, point p,
				(select max_order_no, min_order_no, min.course_no 
                    from(select max(order_no) max_order_no, course_no from point p group by course_no) max,
                        (select min(order_no) min_order_no, course_no from point p group by course_no) min
                         where max.course_no = min.course_no) mp
		where c.user_no = u.user_no
		and c.course_no = p.course_no
		and (p.course_no = mp.course_no and (p.order_no = mp.min_order_no or p.order_no = mp.max_order_no));
		and x > #{x} - 9
		and x < #{x} + 9
		and y > #{y} - 6
		and y < #{y} + 6
	]]>
	</select>
	
	<!-- 키워드별 검색 -->
	<select id="titleList" parameterType="map" resultType="map">
	<![CDATA[
		select	c.course_no, title, distance, course_time, course_category, difficulty,
				id,
				p.order_no, x, y
		from course c, users u, point p,
				(select max(order_no) order_no, course_no from point p group by course_no) mp
		where c.user_no = u.user_no
		and c.course_no = p.course_no
		and (p.order_no = 0 or (p.course_no = mp.course_no and p.order_no = mp.order_no))
		and keyword like '%#{keyword}%'
	]]>
	</select>
	
	
</mapper>